# 任务管理抽奖系统 - 设计文档

## 1. 项目概述

### 1.1 项目简介
这是一个基于Web的任务管理应用，通过权重系统随机抽取任务，完成任务后根据完成时间获得抽奖机会，激励用户高效完成任务。

### 1.2 核心功能
- 任务管理：创建、编辑、删除任务，为任务分配权重
- 权重抽取：优雅的权重随机抽取机制
- 时间管理：为任务设定完成时限
- 抽奖系统：根据完成情况获得抽奖机会，奖品也有权重
- 回收站：已完成任务自动归档，30天后清除

### 1.3 技术栈
- **后端**: Node.js + Express
- **前端**: HTML + CSS + JavaScript (原生或轻量框架)
- **数据库**: SQLite (便于本地部署) 或 PostgreSQL (生产环境)
- **实时通信**: WebSocket (可选，用于实时更新)

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────┐
│   Web前端    │
│  (HTML/CSS/JS)│
└──────┬──────┘
       │ HTTP/WebSocket
┌──────▼──────┐
│  Express API │
│   (Node.js)  │
└──────┬──────┘
       │
┌──────▼──────┐
│   数据库     │
│  (SQLite)   │
└─────────────┘
```

### 2.2 目录结构
```
task-gambling/
├── server/
│   ├── app.js              # 主应用入口
│   ├── routes/             # 路由定义
│   │   ├── tasks.js        # 任务相关路由
│   │   ├── lottery.js      # 抽奖相关路由
│   │   └── prizes.js       # 奖品相关路由
│   ├── models/             # 数据模型
│   │   ├── Task.js
│   │   ├── Prize.js
│   │   └── Lottery.js
│   ├── services/           # 业务逻辑
│   │   ├── taskService.js
│   │   ├── lotteryService.js
│   │   └── cleanupService.js
│   ├── middleware/         # 中间件
│   │   └── errorHandler.js
│   └── config/             # 配置文件
│       └── database.js
├── public/                 # 静态文件
│   ├── index.html
│   ├── css/
│   │   └── style.css
│   ├── js/
│   │   ├── app.js
│   │   ├── taskManager.js
│   │   ├── lottery.js
│   │   └── ui.js
│   └── assets/
├── package.json
├── README.md
└── 设计文档.md
```

## 3. 数据库设计

### 3.1 任务表 (tasks)
```sql
CREATE TABLE tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    description TEXT,
    weight INTEGER NOT NULL DEFAULT 1,  -- 权重，用于抽取
    status TEXT DEFAULT 'pending',      -- pending, in_progress, completed, archived
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    started_at DATETIME,                -- 开始时间（抽取后）
    completed_at DATETIME,              -- 完成时间
    time_limit INTEGER,                 -- 时间限制（分钟）
    archived_at DATETIME                -- 归档时间（放入回收站）
);
```

### 3.2 奖品表 (prizes)
```sql
CREATE TABLE prizes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    weight INTEGER NOT NULL DEFAULT 1,  -- 权重，用于抽奖
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT 1
);
```

### 3.3 抽奖记录表 (lottery_records)
```sql
CREATE TABLE lottery_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER,
    prize_id INTEGER,                   -- NULL表示未中奖
    draw_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    time_exceeded INTEGER DEFAULT 0,    -- 超时小时数
    no_prize_probability REAL,          -- 无奖概率
    FOREIGN KEY (task_id) REFERENCES tasks(id),
    FOREIGN KEY (prize_id) REFERENCES prizes(id)
);
```

## 4. 核心功能设计

### 4.1 任务管理

#### 4.1.1 创建任务
- **输入**: 任务标题、描述、权重
- **验证**: 权重必须为正整数
- **存储**: 保存到数据库，状态为pending

#### 4.1.2 权重抽取算法
使用加权随机算法（Weighted Random Selection）：
```javascript
// 伪代码
function weightedRandomSelect(tasks) {
    // 计算总权重
    totalWeight = sum(tasks.map(t => t.weight));
    
    // 生成随机数
    random = Math.random() * totalWeight;
    
    // 遍历找到对应的任务
    currentWeight = 0;
    for (task of tasks) {
        currentWeight += task.weight;
        if (random <= currentWeight) {
            return task;
        }
    }
}
```

#### 4.1.3 抽取动画设计
- 显示所有待抽取任务
- 快速轮播高亮任务（速度逐渐减慢）
- 最终停在选中的任务上
- 使用CSS动画和JavaScript控制

### 4.2 时间管理

#### 4.2.1 设定时间限制
- 用户抽取任务后，设定完成时限（小时或分钟）
- 记录开始时间（started_at）
- 状态改为in_progress

#### 4.2.2 完成时间计算
- 计算实际完成时间
- 计算超时小时数：`Math.ceil((completed_at - started_at - time_limit) / 60)`
- 如果未超时，超时小时数为0或负数

### 4.3 抽奖系统

#### 4.3.1 无奖概率计算
```javascript
function calculateNoPrizeProbability(hoursExceeded) {
    // 每超出一小时，无奖几率增大10%
    return Math.min(hoursExceeded * 0.1, 1.0); // 最大100%
}
```

#### 4.3.2 抽奖算法
```javascript
function drawLottery(hoursExceeded) {
    noPrizeProb = calculateNoPrizeProbability(hoursExceeded);
    
    // 先判断是否无奖
    if (Math.random() < noPrizeProb) {
        return null; // 未中奖
    }
    
    // 从奖品池中按权重抽取
    prizes = getActivePrizes();
    return weightedRandomSelect(prizes);
}
```

#### 4.3.3 抽奖动画
- 显示奖品转盘或卡片翻转效果
- 逐渐减速，最终停在选中的奖品上
- 如果未中奖，显示"再接再厉"等提示

### 4.4 回收站系统

#### 4.4.1 任务归档
- 任务完成后，用户可选择放入回收站
- 记录archived_at时间
- 状态改为archived

#### 4.4.2 自动清理
- 定时任务（每天执行一次）
- 查找archived_at超过30天的任务
- 自动删除这些任务

## 5. API设计

### 5.1 任务相关API

#### GET /api/tasks
获取所有任务
- **查询参数**: 
  - `status`: 筛选状态 (pending, in_progress, completed, archived)
- **响应**: 
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "title": "完成任务A",
      "weight": 5,
      "status": "pending",
      "created_at": "2024-01-01T10:00:00Z"
    }
  ]
}
```

#### POST /api/tasks
创建新任务
- **请求体**:
```json
{
  "title": "新任务",
  "description": "任务描述",
  "weight": 3
}
```
- **响应**: 创建的任务对象

#### GET /api/tasks/:id
获取单个任务详情

#### PUT /api/tasks/:id
更新任务
- **请求体**: 可更新title, description, weight

#### POST /api/tasks/draw
抽取任务
- **响应**: 抽取到的任务对象

#### POST /api/tasks/:id/start
开始任务（设定时间限制）
- **请求体**:
```json
{
  "time_limit": 120  // 分钟
}
```

#### POST /api/tasks/:id/complete
完成任务
- **响应**: 
```json
{
  "success": true,
  "task": {...},
  "hours_exceeded": 0,
  "lottery_eligible": true
}
```

#### POST /api/tasks/:id/archive
将任务放入回收站

#### DELETE /api/tasks/:id
永久删除任务

### 5.2 奖品相关API

#### GET /api/prizes
获取所有奖品

#### POST /api/prizes
创建奖品
- **请求体**:
```json
{
  "name": "奖品名称",
  "description": "奖品描述",
  "weight": 2
}
```

#### PUT /api/prizes/:id
更新奖品

#### DELETE /api/prizes/:id
删除奖品（软删除，设置is_active=false）

### 5.3 抽奖相关API

#### POST /api/lottery/draw
执行抽奖
- **请求体**:
```json
{
  "task_id": 1,
  "hours_exceeded": 0
}
```
- **响应**:
```json
{
  "success": true,
  "prize": {...},  // 或 null
  "no_prize_probability": 0.0
}
```

#### GET /api/lottery/history
获取抽奖历史记录

## 6. 前端UI设计

### 6.1 页面布局

#### 主页面结构
```
┌─────────────────────────────────────┐
│           导航栏                      │
├─────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐        │
│  │ 任务列表  │  │ 奖品管理  │        │
│  │          │  │          │        │
│  │          │  │          │        │
│  └──────────┘  └──────────┘        │
│                                     │
│  ┌─────────────────────────────┐   │
│  │     抽取任务按钮              │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │     抽奖历史                  │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

### 6.2 主要界面

#### 6.2.1 任务管理界面
- **任务列表**: 显示所有任务，按状态分组
- **创建任务表单**: 标题、描述、权重输入
- **任务卡片**: 显示任务信息，操作按钮（编辑、删除、归档）

#### 6.2.2 抽取任务界面
- **抽取按钮**: 大而醒目的按钮
- **抽取动画**: 
  - 任务卡片快速轮播
  - 逐渐减速
  - 最终高亮选中的任务
  - 使用CSS transition和JavaScript控制

#### 6.2.3 任务执行界面
- **倒计时显示**: 显示剩余时间
- **完成按钮**: 完成任务
- **时间设定**: 开始任务时设定时间限制

#### 6.2.4 抽奖界面
- **转盘或卡片翻转动画**
- **奖品展示**: 中奖后显示奖品信息
- **未中奖提示**: 友好的提示信息

#### 6.2.5 奖品管理界面
- **奖品列表**: 显示所有奖品
- **创建奖品表单**: 名称、描述、权重
- **编辑/删除功能**

### 6.3 UI/UX设计原则

1. **简洁美观**: 使用现代化的设计风格
2. **响应式设计**: 适配不同屏幕尺寸
3. **动画流畅**: 抽取和抽奖过程使用优雅的动画
4. **反馈及时**: 操作后立即给出反馈
5. **色彩搭配**: 使用柔和的配色方案

## 7. 部署方案

### 7.1 开发环境
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

### 7.2 生产环境部署（Ubuntu）

#### 7.2.1 使用PM2管理进程
```bash
# 安装PM2
npm install -g pm2

# 启动应用
pm2 start server/app.js --name task-gambling

# 设置开机自启
pm2 startup
pm2 save
```

#### 7.2.2 使用Nginx反向代理
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

#### 7.2.3 环境变量配置
创建 `.env` 文件：
```
PORT=3000
NODE_ENV=production
DB_PATH=./data/tasks.db
```

### 7.3 定时任务
使用node-cron实现自动清理：
```javascript
const cron = require('node-cron');
const cleanupService = require('./services/cleanupService');

// 每天凌晨2点执行清理
cron.schedule('0 2 * * *', () => {
    cleanupService.cleanArchivedTasks();
});
```

## 8. 安全考虑

1. **输入验证**: 所有用户输入进行验证和清理
2. **SQL注入防护**: 使用参数化查询
3. **XSS防护**: 前端输出进行转义
4. **CORS配置**: 限制允许的源
5. **速率限制**: 防止API滥用

## 9. 扩展功能（可选）

1. **用户系统**: 多用户支持，每个用户独立的任务和奖品
2. **数据统计**: 任务完成率、抽奖统计等
3. **任务分类**: 支持任务分类和标签
4. **提醒功能**: 任务时间提醒
5. **数据导出**: 导出任务和抽奖记录
6. **主题切换**: 支持深色/浅色主题

## 10. 开发计划

### 阶段一：基础功能（1-2周）
- [ ] 数据库设计和初始化
- [ ] 基础API开发
- [ ] 任务CRUD功能
- [ ] 基础UI界面

### 阶段二：核心功能（1-2周）
- [ ] 权重抽取算法实现
- [ ] 抽取动画效果
- [ ] 时间管理功能
- [ ] 抽奖系统实现

### 阶段三：完善和优化（1周）
- [ ] 回收站功能
- [ ] 自动清理任务
- [ ] UI/UX优化
- [ ] 测试和bug修复

### 阶段四：部署（1周）
- [ ] 生产环境配置
- [ ] 部署文档
- [ ] 性能优化

## 11. 技术细节

### 11.1 权重抽取优化
- 缓存总权重，避免每次计算
- 使用二分查找优化大列表的抽取

### 11.2 动画性能
- 使用CSS transform而非改变位置属性
- 使用requestAnimationFrame优化动画
- 避免重排和重绘

### 11.3 数据库优化
- 为常用查询字段添加索引
- 定期清理过期数据
- 考虑数据备份策略

## 12. 测试策略

1. **单元测试**: 测试核心算法（权重抽取、抽奖算法）
2. **集成测试**: 测试API端点
3. **端到端测试**: 测试完整用户流程
4. **性能测试**: 测试大量数据下的性能

---

## 附录

### A. 依赖包列表
```json
{
  "dependencies": {
    "express": "^4.18.2",
    "sqlite3": "^5.1.6",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "node-cron": "^3.0.2"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
```

### B. 配置文件示例
- `.env`: 环境变量
- `package.json`: 项目配置
- `ecosystem.config.js`: PM2配置

